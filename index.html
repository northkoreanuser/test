<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•´ì‹œ ì¶”ì²¨ ì‹œìŠ¤í…œ</title>
    <style>
        /* ê¸°ì¡´ CSS ì½”ë“œëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€ */
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; border-radius: 4px 4px 0 0; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 16px; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #4CAF50; color: white; }
        .tabcontent { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; animation: fadeEffect 1s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
        button.action-btn { background-color: #4CAF50; color: white; border: none; padding: 10px 15px; margin: 10px 2px; cursor: pointer; border-radius: 4px; }
        button.action-btn:hover { background-color: #45a049; }
        button.danger-btn { background-color: #f44336; color: white; border: none; padding: 10px 15px; margin: 10px 2px; cursor: pointer; border-radius: 4px; }
        button.danger-btn:hover { background-color: #da190b; }
        input[type="email"] { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 2px solid #ccc; border-radius: 4px; }
        .result-box { margin-top: 20px; padding: 15px; border-radius: 4px; background-color: #f8f8f8; }
        #hashLoading, #drawLoading { display: none; color: #4CAF50; margin: 10px 0; }
        .source-links, .file-links { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; font-size: 0.9em; }
        .source-links a, .file-links a { color: #0366d6; text-decoration: none; margin: 0 5px; } /* ê°„ê²© ì¡°ì • */
        .source-links a:hover, .file-links a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>í•´ì‹œ ì¶”ì²¨ ì‹œìŠ¤í…œ</h1>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'drawTab')">ë‹¹ì²¨ì í™•ì¸</button>
        <button class="tablinks" onclick="openTab(event, 'checkTab')">ì´ë©”ì¼ í™•ì¸</button>
    </div>

    <div id="drawTab" class="tabcontent" style="display: block;">
        <button class="action-btn" onclick="drawWinner()">ë‹¹ì²¨ì ì¶”ì²¨ ì‹¤í–‰</button>
        <button class="danger-btn" onclick="clearWinnerHistory()">ì¶”ì²¨ ì´ë ¥ ì‚­ì œ (í…ŒìŠ¤íŠ¸ìš©)</button>
        <div id="drawLoading">ì¶”ì²¨ ì§„í–‰ ì¤‘...</div>
        <div id="result" class="result-box"></div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
            * ëª¨ë“  ì¶”ì²¨ ê³¼ì •ì€ ê³µê°œëœ 
            <a href="hash.txt" target="_blank">hash.txt</a> 
            <span id="hashTxtCommitLink"></span>
            íŒŒì¼ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
            ì´ íŒŒì¼ì€ GitHub ì»¤ë°‹ ì´ë ¥ì„ í†µí•´ ì¡°ì‘ ë¶ˆê°€ëŠ¥í•¨ì„ ë³´ì¦í•©ë‹ˆë‹¤.
            **`test@test.com` ì´ë©”ì¼ì€ ì‹œìŠ¤í…œ ì‹œì—°ì„ ìœ„í•œ ê²ƒìœ¼ë¡œ, ì‹¤ì œ ì¶”ì²¨ ëŒ€ìƒì—ì„œëŠ” ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.**
        </p>
    </div>

    <div id="checkTab" class="tabcontent">
        <input type="email" id="emailInput" value="test@test.com" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button class="action-btn" onclick="generateAndCheckHash()">ë‚´ ì´ë©”ì¼ í•´ì‹œ í™•ì¸</button>
        <div id="hashLoading">í•´ì‹œ ìƒì„± ë° í™•ì¸ ì¤‘...</div>
        <div id="hashResult" class="result-box"></div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
            ğŸ’¡ ì´ë©”ì¼ í•´ì‹œë¥¼ ìƒì„±í•œ í›„, íˆ¬ëª…í•œ ì‘ëª¨ ê¸°ë¡ì„ ìœ„í•´ <br>
            <a href="hash.txt" target="_blank" style="color: #4CAF50; text-decoration: underline; font-weight: bold;">hash.txt íŒŒì¼</a>ì—ì„œ ì§ì ‘ <span style="font-weight: bold; color: #e94560;">Ctrl+F (Mac: Cmd+F)</span>ë¥¼ ëˆŒëŸ¬ <br>
            ìƒì„±ëœ í•´ì‹œê°€ ëª©ë¡ì— ìˆëŠ”ì§€ ê²€ìƒ‰í•˜ì—¬ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
    </div>

    <div class="source-links">
        <p>
            ì´ í˜ì´ì§€ì˜ ì†ŒìŠ¤ì½”ë“œ íˆ¬ëª…ì„±ì„ í™•ì¸í•˜ì„¸ìš”:
            <span id="indexSourceLinks"></span>
        </p>
    </div>

    <script>
        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999; path=/;';
        }

        // --- í•´ì‹œ ë° ì¶”ì²¨ ë¡œì§ ---

        // SHA-512 í•´ì‹œ ìƒì„± í•¨ìˆ˜
        async function generateSHA512(message) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-512', data);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error("SHA-512 ì˜¤ë¥˜:", error);
                throw new Error("í•´ì‹œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ HTTPS í™˜ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        // test@test.com ì˜ í•´ì‹œë¥¼ ë¯¸ë¦¬ ê³„ì‚°í•˜ì—¬ ì €ì¥
        let TEST_EMAIL_HASH = '';
        (async () => {
            try {
                TEST_EMAIL_HASH = await generateSHA512('test@test.com');
            } catch (e) {
                console.error("í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ í•´ì‹œ ìƒì„± ì‹¤íŒ¨:", e);
            }
        })();


        // í•´ì‹œ ìƒì„± ë° í™•ì¸ í•¨ìˆ˜
        async function generateAndCheckHash() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) {
                alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const loader = document.getElementById('hashLoading');
            const resultDiv = document.getElementById('hashResult');

            loader.style.display = 'block';
            resultDiv.innerHTML = '';

            try {
                const userHash = await generateSHA512(email);

                const response = await fetch('hash.txt');
                if (!response.ok) {
                    throw new Error("ì‘ëª¨ í•´ì‹œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                const hashesInFile = (await response.text()).split('\n').map(h => h.trim()).filter(h => h);

                let found = false;
                if (hashesInFile.includes(userHash)) {
                    found = true;
                }

                resultDiv.innerHTML = `
                    <p><strong>ì…ë ¥ëœ ì´ë©”ì¼ì˜ í•´ì‹œ:</strong> ${userHash}</p>
                    <p style="color: ${found ? 'green' : 'red'}; font-weight: bold;">
                        ${found ? 'âœ… ê·€í•˜ì˜ í•´ì‹œê°€ ì‘ëª¨ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.' : 'âŒ ê·€í•˜ì˜ í•´ì‹œê°€ ì‘ëª¨ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤.'}
                    </p>
                `;
                if (!found) {
                    resultDiv.innerHTML += `
                        <p style="font-size: 0.95em; margin-top: 15px; color: #888;">
                            í˜¹ì‹œ ì˜¤íƒ€ê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜, ëª¨ë“  ì‘ëª¨ ê¸°ë¡ì´ ë‹´ê¸´ <br>
                            <a href="hash.txt" target="_blank" style="color: #4CAF50; text-decoration: underline; font-weight: bold;">hash.txt íŒŒì¼</a>ì„ ì§ì ‘ ì—´ì–´ <br>
                            <span style="font-weight: bold; color: #e94560;">Ctrl+F (Mac: Cmd+F)</span>ë¡œ ìƒì„±ëœ í•´ì‹œë¥¼ ê²€ìƒ‰í•˜ì—¬ í™•ì¸í•´ ë³´ì„¸ìš”.
                        </p>
                    `;
                } else {
                     resultDiv.innerHTML += `
                        <p style="font-size: 0.85em; margin-top: 10px; color: #a0a0a0;">
                            ë” ìì„¸í•œ í™•ì¸ì„ ì›í•˜ì‹œë©´ <a href="hash.txt" target="_blank" style="color: #4CAF50; text-decoration: underline;">hash.txt íŒŒì¼</a>ì„ ì—´ì–´ ì§ì ‘ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color:red;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        // ë‹¹ì²¨ì ì¶”ì²¨ í•¨ìˆ˜
        async function drawWinner() {
            const loader = document.getElementById('drawLoading');
            const resultDiv = document.getElementById('result');

            loader.style.display = 'block';
            resultDiv.innerHTML = '';

            try {
                let winnerHash = getCookie('lastWinnerHash');
                let isLoadedFromCookie = false;

                const response = await fetch('hash.txt');
                if (!response.ok) {
                    throw new Error("ì‘ëª¨ í•´ì‹œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                let hashes = (await response.text()).split('\n').map(h => h.trim()).filter(h => h);

                if (TEST_EMAIL_HASH) {
                    hashes = hashes.filter(h => h !== TEST_EMAIL_HASH);
                }
                
                if (!hashes.length) {
                    throw new Error("ì¶”ì²¨ ê°€ëŠ¥í•œ í•´ì‹œê°€ ì—†ìŠµë‹ˆë‹¤. (ìœ íš¨í•œ ì‘ëª¨ìê°€ ì—†ëŠ” ê²½ìš°)");
                }

                const totalEligibleHashes = hashes.length;

                if (!winnerHash || !hashes.includes(winnerHash)) {
                    if (winnerHash && !hashes.includes(winnerHash)) {
                        console.warn("ì¿ í‚¤ì— ì €ì¥ëœ ë‹¹ì²¨ í•´ì‹œê°€ í˜„ì¬ ì¶”ì²¨ ê°€ëŠ¥í•œ ëª©ë¡ì— ì—†ì–´ ìƒˆë¡œìš´ ì¶”ì²¨ì„ ì§„í–‰í•©ë‹ˆë‹¤.");
                    }
                    const randomIndex = Math.floor(Math.random() * hashes.length);
                    winnerHash = hashes[randomIndex];
                    setCookie('lastWinnerHash', winnerHash, 7);
                } else {
                    isLoadedFromCookie = true;
                }

                resultDiv.innerHTML = `
                    <p><strong>ì´ ì‘ëª¨ í•´ì‹œ ìˆ˜:</strong> ${totalEligibleHashes}ê°œ</p>
                    <p style="font-size: 1.2em; color: #4CAF50; font-weight: bold;">
                        âœ¨ ë‹¹ì²¨ í•´ì‹œ: ${winnerHash} âœ¨
                    </p>
                    <p style="margin-top: 15px;">
                        ë‹¹ì²¨ë˜ì…¨ë‹¤ë©´, ìœ„ í•´ì‹œì™€ ì¼ì¹˜í•˜ëŠ” ì´ë©”ì¼ë¡œ ì—°ë½ì£¼ì„¸ìš”: <strong style="color: #e94560;">winner@example.com</strong>
                    </p>
                    <p style="font-size: 0.9em; color: #888;">
                        (ì°¸ê³ : ë‹¹ì²¨ í™•ì¸ì€ 'ì´ë©”ì¼ í™•ì¸' íƒ­ì—ì„œ ìì‹ ì˜ ì´ë©”ì¼ í•´ì‹œë¥¼ ìƒì„±í•˜ì—¬ ì§ì ‘ ë¹„êµí•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
                    </p>
                `;
                if (isLoadedFromCookie) {
                    resultDiv.innerHTML += '<p style="color: blue; font-size: 0.85em; margin-top: 10px;">(ì´ì „ ì¶”ì²¨ ê²°ê³¼ê°€ ì¿ í‚¤ì—ì„œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.)</p>';
                }

            } catch (error) {
                resultDiv.innerHTML = `<p style="color:red;">${error.message}</p>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        // ì¶”ì²¨ ì´ë ¥ ì œê±° í•¨ìˆ˜
        function clearWinnerHistory() {
            if (confirm("ì •ë§ ì¶”ì²¨ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¡œì»¬ ë¸Œë¼ìš°ì € ì¿ í‚¤ì—ì„œë§Œ ì‚­ì œë˜ë©°, ìƒˆë¡œê³ ì¹¨ ì‹œ ë‹¤ì‹œ ì¶”ì²¨ ê°€ëŠ¥)")) {
                eraseCookie('lastWinnerHash');
                document.getElementById('result').innerHTML = '<p style="color: green;">ì¶”ì²¨ ì´ë ¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ìƒˆë¡œìš´ ì¶”ì²¨ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                console.log("ì¶”ì²¨ ì´ë ¥ ì¿ í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tablinks').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }

        // GitHub ì†ŒìŠ¤ì½”ë“œ ë° íŒŒì¼ ì´ë ¥ ë§í¬ ìƒì„± í•¨ìˆ˜
        function generateGitHubLinks() {
            const currentUrl = window.location.href;
            const urlParts = currentUrl.split('/');
            
            let userName = '';
            let repoName = '';

            // GitHub Pages ì£¼ì†Œ (ì˜ˆ: https://user.github.io/repo/index.html)
            if (urlParts[2] && urlParts[2].endsWith('.github.io')) {
                userName = urlParts[2].split('.')[0];
                repoName = urlParts[3] || userName; // user.github.io/ -> repoName = user, user.github.io/repo -> repoName = repo
            } 
            // GitHub ì €ì¥ì†Œ ì§ì ‘ ì ‘ê·¼ ì£¼ì†Œ (ì˜ˆ: https://github.com/user/repo/blob/main/index.html)
            else if (urlParts[2] === 'github.com' && urlParts[3] && urlParts[4]) {
                userName = urlParts[3];
                repoName = urlParts[4];
            } else {
                // ë¡œì»¬ íŒŒì¼ ë“±, GitHub Pages/Repo í˜•íƒœê°€ ì•„ë‹Œ ê²½ìš° ë§í¬ ìƒì„± ìƒëµ
                const indexLinksDiv = document.getElementById('indexSourceLinks');
                if (indexLinksDiv) {
                    indexLinksDiv.innerHTML = 'ë¡œì»¬ í™˜ê²½ ë˜ëŠ” ë¹„ GitHub Pages/Repo ì£¼ì†Œì—ì„œëŠ” ì†ŒìŠ¤ì½”ë“œ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
                const hashTxtCommitLinkDiv = document.getElementById('hashTxtCommitLink');
                if (hashTxtCommitLinkDiv) {
                     hashTxtCommitLinkDiv.innerHTML = ''; // hash.txt ì˜† ë§í¬ë„ ì§€ì›€
                }
                return;
            }

            const branch = 'main'; // ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„ (í•„ìš”ì‹œ ë³€ê²½ ê°€ëŠ¥)
            const fileName = 'index.html';
            const hashTxtFileName = 'hash.txt';

            // --- index.html ê´€ë ¨ ë§í¬ ---
            const githubViewLink = `https://github.com/${userName}/${repoName}/blob/${branch}/${fileName}`;
            const githubRawLink = `https://github.io/${userName}/${repoName}/${fileName}`; // GitHub Pages í˜¸ìŠ¤íŒ… ê¸°ë°˜ Raw ë§í¬
            const githubCommitLink = `https://github.com/${userName}/${repoName}/commits/${branch}/${fileName}`;

            const indexLinksDiv = document.getElementById('indexSourceLinks');
            if (indexLinksDiv) {
                indexLinksDiv.innerHTML = `
                    <a href="${githubViewLink}" target="_blank">GitHubì—ì„œ ë³´ê¸°</a> |
                    <a href="${githubRawLink}" target="_blank">Raw ì½”ë“œ ì§ì ‘ ë³´ê¸°</a> |
                    <a href="${githubCommitLink}" target="_blank">ìˆ˜ì • ì´ë ¥ í™•ì¸</a>
                `;
            }

            // --- hash.txt ê´€ë ¨ ë§í¬ ---
            const hashTxtCommitLink = `https://github.com/${userName}/${repoName}/commits/${branch}/${hashTxtFileName}`;
            const hashTxtCommitLinkDiv = document.getElementById('hashTxtCommitLink');
            if (hashTxtCommitLinkDiv) {
                hashTxtCommitLinkDiv.innerHTML = `
                    (<a href="${hashTxtCommitLink}" target="_blank">ìˆ˜ì • ì´ë ¥ í™•ì¸</a>)
                `;
            }
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ íƒ­ ì—´ê¸° ë° GitHub ë§í¬ ìƒì„±
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.tablinks.active').click();
            generateGitHubLinks(); // GitHub ì†ŒìŠ¤ì½”ë“œ ë° íŒŒì¼ ì´ë ¥ ë§í¬ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
        });
    </script>
</body>
</html>
