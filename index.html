<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해시 추첨 시스템</title>
    <style>
        /* 기존 CSS 코드는 동일하게 유지 */
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; border-radius: 4px 4px 0 0; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 16px; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #4CAF50; color: white; }
        .tabcontent { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; animation: fadeEffect 1s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
        button.action-btn { background-color: #4CAF50; color: white; border: none; padding: 10px 15px; margin: 10px 2px; cursor: pointer; border-radius: 4px; }
        button.action-btn:hover { background-color: #45a049; }
        button.danger-btn { background-color: #f44336; color: white; border: none; padding: 10px 15px; margin: 10px 2px; cursor: pointer; border-radius: 4px; }
        button.danger-btn:hover { background-color: #da190b; }
        input[type="email"], input[type="text"].hash-display { width: calc(100% - 100px); /* 복사 버튼 공간 확보 */ padding: 10px; margin: 8px 0; box-sizing: border-box; border: 2px solid #ccc; border-radius: 4px; display: inline-block; vertical-align: middle; }
        button.copy-btn { background-color: #007bff; color: white; border: none; padding: 10px 15px; margin-left: 5px; cursor: pointer; border-radius: 4px; width: 90px; vertical-align: middle; }
        button.copy-btn:hover { background-color: #0056b3; }
        .result-box { margin-top: 20px; padding: 15px; border-radius: 4px; background-color: #f8ff8; }
        #hashLoading, #drawLoading { display: none; color: #4CAF50; margin: 10px 0; }
        .source-links, .file-links { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; font-size: 0.9em; }
        .source-links a, .file-links a { color: #0366d6; text-decoration: none; margin: 0 5px; } /* 간격 조정 */
        .source-links a:hover, .file-links a:hover { text-decoration: underline; }
        .file-info-container { display: inline-block; margin-left: 5px; font-size: 0.9em; color: #888; } /* hash.txt 관련 정보 컨테이너 */
    </style>
</head>
<body>
    <h1>해시 추첨 시스템</h1>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'drawTab')">당첨자 확인</button>
        <button class="tablinks" onclick="openTab(event, 'checkTab')">이메일 확인</button>
    </div>

    <div id="drawTab" class="tabcontent" style="display: block;">
        <button class="action-btn" onclick="drawWinner()">당첨자 추첨 실행</button>
        <button class="danger-btn" onclick="clearWinnerHistory()">추첨 이력 삭제 (테스트용)</button>
        <div id="drawLoading">추첨 진행 중...</div>
        <div id="result" class="result-box"></div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
            * 모든 추첨 과정은 공개된 
            <span id="hashTxtLink_drawTab"></span> <span class="file-info-container">
                <span id="hashTxtCommitLink_drawTab"></span> </span>
            파일 데이터를 기반으로 합니다.
            이 파일은 GitHub 커밋 이력을 통해 조작 불가능함을 보증합니다.
            **`test@test.com` 이메일은 시스템 시연을 위한 것으로, 실제 추첨 대상에서는 자동으로 제외됩니다.**
        </p>
    </div>

    <div id="checkTab" class="tabcontent">
        <input type="email" id="emailInput" value="test@test.com" placeholder="이메일을 입력하세요">
        <button class="action-btn" onclick="generateAndCheckHash()">내 이메일 해시 확인</button>
        <div id="hashLoading">해시 생성 및 확인 중...</div>
        <div id="hashResult" class="result-box">
            <p><strong>입력된 이메일의 해시:</strong></p>
            <div style="display: flex; align-items: center;">
                <input type="text" id="userHashDisplay" class="hash-display" readonly>
                <button class="copy-btn" onclick="copyToClipboard('userHashDisplay')">복사</button>
            </div>
            <p id="hashVerificationResult"></p>
        </div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
            💡 이메일 해시를 생성한 후, 투명한 응모 기록을 위해 <br>
            <span id="hashTxtLink_checkTab"></span> <span class="file-info-container">
                <span id="hashTxtCommitLink_checkTab"></span> </span>
            에서 직접 <span style="font-weight: bold; color: #e94560;">Ctrl+F (Mac: Cmd+F)</span>를 눌러 <br>
            생성된 해시가 목록에 있는지 검색하여 확인해 볼 수 있습니다.
        </p>
    </div>

    <div class="source-links">
        <p>
            이 페이지의 소스코드 투명성을 확인하세요:
            <span id="indexSourceLinks"></span>
        </p>
    </div>

    <script>
        // --- 유틸리티 함수 ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999; path=/';
        }

        // 텍스트를 클립보드에 복사하는 함수
        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); // 모바일용
            try {
                document.execCommand("copy");
                alert("복사되었습니다: " + copyText.value);
            } catch (err) {
                console.error('클립보드 복사 실패:', err);
                alert("복사에 실패했습니다. 수동으로 복사해주세요.");
            }
        }

        // --- 해시 및 추첨 로직 ---

        // SHA-512 해시 생성 함수
        async function generateSHA512(message) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-512', data);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error("SHA-512 오류:", error);
                throw new Error("해시 생성에 실패했습니다. 이 기능을 사용하려면 HTTPS 환경이 필요합니다.");
            }
        }

        // test@test.com 의 해시를 미리 계산하여 저장
        let TEST_EMAIL_HASH = '';
        (async () => {
            try {
                TEST_EMAIL_HASH = await generateSHA512('test@test.com');
            } catch (e) {
                console.error("테스트 이메일 해시 생성 실패:", e);
            }
        })();


        // 해시 생성 및 확인 함수
        async function generateAndCheckHash() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }

            const loader = document.getElementById('hashLoading');
            const userHashDisplay = document.getElementById('userHashDisplay');
            const hashVerificationResult = document.getElementById('hashVerificationResult');

            loader.style.display = 'block';
            userHashDisplay.value = ''; // 기존 값 초기화
            hashVerificationResult.innerHTML = ''; // 기존 값 초기화

            try {
                const userHash = await generateSHA512(email);
                userHashDisplay.value = userHash; // 해시 값을 입력 필드에 표시

                // hash.txt를 Raw URL로 Fetch
                const hashTxtRawLink = document.getElementById('hashTxtLink_checkTab').querySelector('a').href; // 현재 페이지에 삽입된 hash.txt Raw 링크를 가져옴
                const response = await fetch(hashTxtRawLink); // Raw URL로 fetch
                if (!response.ok) {
                    throw new Error("응모 해시 목록을 불러올 수 없습니다. (Network Error or File Not Found)");
                }
                const hashesInFile = (await response.text()).split('\n').map(h => h.trim()).filter(h => h);

                let found = false;
                if (hashesInFile.includes(userHash)) {
                    found = true;
                }

                hashVerificationResult.innerHTML = `
                    <p style="color: ${found ? 'green' : 'red'}; font-weight: bold;">
                        ${found ? '✅ 귀하의 해시가 응모 목록에 있습니다.' : '❌ 귀하의 해시가 응모 목록에 없습니다.'}
                    </p>
                `;
                // 이메일 확인 결과 내 중첩된 hash.txt 링크 (없을 경우)
                if (!found) {
                    hashVerificationResult.innerHTML += `
                        <p style="font-size: 0.95em; margin-top: 15px; color: #888;">
                            혹시 오타가 없는지 확인하거나, 모든 응모 기록이 담긴 <br>
                            <span id="hashTxtLink_checkTab_nested"></span> <span class="file-info-container">
                                <span id="hashTxtCommitLink_checkTab_nested"></span> </span>
                            에서 직접 <span style="font-weight: bold; color: #e94560;">Ctrl+F (Mac: Cmd+F)</span>를 눌러 <br>
                            생성된 해시를 검색하여 확인해 보세요.
                        </p>
                    `;
                } else {
                     hashVerificationResult.innerHTML += `
                        <p style="font-size: 0.85em; margin-top: 10px; color: #a0a0a0;">
                            더 자세한 확인을 원하시면 
                            <span id="hashTxtLink_checkTab_nested_found"></span> <span class="file-info-container">
                                <span id="hashTxtCommitLink_checkTab_nested_found"></span> </span>
                            을 열어 직접 검색할 수 있습니다.
                        </p>
                    `;
                }
                // generateGitHubLinks를 다시 호출하여 동적 링크 업데이트
                generateGitHubLinks(); 
            } catch (error) {
                hashVerificationResult.innerHTML = `<p style="color:red;">오류 발생: ${error.message}</p>`;
                userHashDisplay.value = '';
            } finally {
                loader.style.display = 'none';
            }
        }

        // 당첨자 추첨 함수
        async function drawWinner() {
            const loader = document.getElementById('drawLoading');
            const resultDiv = document.getElementById('result');

            loader.style.display = 'block';
            resultDiv.innerHTML = '';

            try {
                let winnerHash = getCookie('lastWinnerHash');
                let isLoadedFromCookie = false;

                // hash.txt를 Raw URL로 Fetch
                const hashTxtRawLink = document.getElementById('hashTxtLink_drawTab').querySelector('a').href; // 현재 페이지에 삽입된 hash.txt Raw 링크를 가져옴
                const response = await fetch(hashTxtRawLink); // Raw URL로 fetch
                if (!response.ok) {
                    throw new Error("응모 해시 목록을 불러올 수 없습니다. (Network Error or File Not Found)");
                }
                let hashes = (await response.text()).split('\n').map(h => h.trim()).filter(h => h);

                if (TEST_EMAIL_HASH) {
                    hashes = hashes.filter(h => h !== TEST_EMAIL_HASH);
                }
                
                if (!hashes.length) {
                    throw new Error("추첨 가능한 해시가 없습니다. (유효한 응모자가 없는 경우)");
                }

                const totalEligibleHashes = hashes.length;

                if (!winnerHash || !hashes.includes(winnerHash)) {
                    if (winnerHash && !hashes.includes(winnerHash)) {
                        console.warn("쿠키에 저장된 당첨 해시가 현재 추첨 가능한 목록에 없어 새로운 추첨을 진행합니다.");
                    }
                    const randomIndex = Math.floor(Math.random() * hashes.length);
                    winnerHash = hashes[randomIndex];
                    setCookie('lastWinnerHash', winnerHash, 7);
                } else {
                    isLoadedFromCookie = true;
                }

                // 결과 박스에 해시 입력 필드와 복사 버튼 추가
                resultDiv.innerHTML = `
                    <p><strong>총 응모 해시 수:</strong> ${totalEligibleHashes}개</p>
                    <p style="font-size: 1.2em; color: #4CAF50; font-weight: bold;">
                        ✨ 당첨 해시:
                    </p>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="winnerHashDisplay" class="hash-display" value="${winnerHash}" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('winnerHashDisplay')">복사</button>
                    </div>
                    <p style="margin-top: 15px;">
                        당첨되셨다면, 위 해시와 일치하는 이메일로 연락주세요: <strong style="color: #e94560;">winner@example.com</strong>
                    </p>
                    <p style="font-size: 0.9em; color: #888;">
                        (참고: 당첨 확인은 '이메일 확인' 탭에서 자신의 이메일 해시를 생성하여 직접 비교해 볼 수 있습니다.)
                    </p>
                `;
                if (isLoadedFromCookie) {
                    resultDiv.innerHTML += '<p style="color: blue; font-size: 0.85em; margin-top: 10px;">(이전 추첨 결과가 쿠키에서 로드되었습니다.)</p>';
                }
                // generateGitHubLinks를 다시 호출하여 동적 링크 업데이트
                generateGitHubLinks();

            } catch (error) {
                resultDiv.innerHTML = `<p style="color:red;">${error.message}</p>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        // 추첨 이력 제거 함수
        function clearWinnerHistory() {
            if (confirm("정말 추첨 이력을 삭제하시겠습니까? (로컬 브라우저 쿠키에서만 삭제되며, 새로고침 시 다시 추첨 가능)")) {
                eraseCookie('lastWinnerHash');
                document.getElementById('result').innerHTML = '<p style="color: green;">추첨 이력이 삭제되었습니다. 이제 새로운 추첨을 실행할 수 있습니다.</p>';
                console.log("추첨 이력 쿠키가 삭제되었습니다.");
            }
        }

        // 탭 전환 함수
        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tablinks').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }

        // GitHub 소스코드 및 파일 이력 링크 생성 함수
        function generateGitHubLinks() {
            const currentUrl = window.location.href;
            const urlParts = currentUrl.split('/');
            
            let userName = '';
            let repoName = '';

            // GitHub Pages 주소 (예: https://user.github.io/repo/index.html)
            if (urlParts[2] && urlParts[2].endsWith('.github.io')) {
                userName = urlParts[2].split('.')[0];
                repoName = urlParts[3] || userName; // user.github.io/ -> repoName = user, user.github.io/repo -> repoName = repo
            } 
            // GitHub 저장소 직접 접근 주소 (예: https://github.com/user/repo/blob/main/index.html)
            else if (urlParts[2] === 'github.com' && urlParts[3] && urlParts[4]) {
                userName = urlParts[3];
                repoName = urlParts[4];
            } else {
                // 로컬 파일 등, GitHub Pages/Repo 형태가 아닌 경우 링크 생성 생략
                const indexLinksDiv = document.getElementById('indexSourceLinks');
                if (indexLinksDiv) {
                    indexLinksDiv.innerHTML = '로컬 환경 또는 비 GitHub Pages/Repo 주소에서는 소스코드 링크를 생성할 수 없습니다.';
                }
                // hash.txt 관련 링크들도 비활성화
                const hashTxtLinkDraw = document.getElementById('hashTxtLink_drawTab');
                if (hashTxtLinkDraw) hashTxtLinkDraw.innerHTML = 'hash.txt'; // 링크 없는 텍스트로 대체
                const hashTxtCommitLinkDraw = document.getElementById('hashTxtCommitLink_drawTab');
                if (hashTxtCommitLinkDraw) hashTxtCommitLinkDraw.innerHTML = '';
                
                const hashTxtLinkCheck = document.getElementById('hashTxtLink_checkTab');
                if (hashTxtLinkCheck) hashTxtLinkCheck.innerHTML = 'hash.txt 파일'; // 링크 없는 텍스트로 대체
                const hashTxtCommitLinkCheck = document.getElementById('hashTxtCommitLink_checkTab');
                if (hashTxtCommitLinkCheck) hashTxtCommitLinkCheck.innerHTML = '';

                const hashTxtLinkCheckNested = document.getElementById('hashTxtLink_checkTab_nested');
                if (hashTxtLinkCheckNested) hashTxtLinkCheckNested.innerHTML = 'hash.txt 파일'; // 링크 없는 텍스트로 대체
                const hashTxtCommitLinkCheckNested = document.getElementById('hashTxtCommitLink_checkTab_nested');
                if (hashTxtCommitLinkCheckNested) hashTxtCommitLinkCheckNested.innerHTML = '';
                
                const hashTxtLinkCheckNestedFound = document.getElementById('hashTxtLink_checkTab_nested_found');
                if (hashTxtLinkCheckNestedFound) hashTxtLinkCheckNestedFound.innerHTML = 'hash.txt 파일'; // 링크 없는 텍스트로 대체
                const hashTxtCommitLinkCheckNestedFound = document.getElementById('hashTxtCommitLink_checkTab_nested_found');
                if (hashTxtCommitLinkCheckNestedFound) hashTxtCommitLinkCheckNestedFound.innerHTML = '';
                return;
            }

            const branch = 'main'; // 기본 브랜치 이름 (필요시 변경 가능)
            const indexFileName = 'index.html';
            const hashTxtFileName = 'hash.txt';

            // --- index.html 관련 링크 ---
            const githubViewLink = `https://github.com/${userName}/${repoName}/blob/${branch}/${indexFileName}`;
            const githubRawLink = `https://raw.githubusercontent.com/${userName}/${repoName}/refs/heads/${branch}/${indexFileName}`; // 정확한 Raw 코드 링크
            const githubCommitLink = `https://github.com/${userName}/${repoName}/commits/${branch}/${indexFileName}`;

            const indexLinksDiv = document.getElementById('indexSourceLinks');
            if (indexLinksDiv) {
                indexLinksDiv.innerHTML = `
                    <a href="${githubViewLink}" target="_blank">GitHub에서 보기</a> |
                    <a href="${githubRawLink}" target="_blank">Raw 코드 직접 보기</a> |
                    <a href="${githubCommitLink}" target="_blank">수정 이력 확인</a>
                `;
            }

            // --- hash.txt 관련 링크 (기본 링크를 Raw URL로 교체) ---
            const hashTxtRawUrl = `https://raw.githubusercontent.com/${userName}/${repoName}/refs/heads/${branch}/${hashTxtFileName}`; 
            const hashTxtCommitLink = `https://github.com/${userName}/${repoName}/commits/${branch}/${hashTxtFileName}`;
            
            const hashTxtMainLinkHtml = `<a href="${hashTxtRawUrl}" target="_blank">hash.txt</a>`;
            const hashTxtMainLinkHtmlBold = `<a href="${hashTxtRawUrl}" target="_blank" style="color: #4CAF50; text-decoration: underline; font-weight: bold;">hash.txt 파일</a>`; // 볼드 스타일 유지
            const hashTxtCommitLinkHtml = `(<a href="${hashTxtCommitLink}" target="_blank">수정 이력 확인</a>)`;

            // 당첨자 확인 탭의 hash.txt 링크
            const hashTxtLinkDraw = document.getElementById('hashTxtLink_drawTab');
            if (hashTxtLinkDraw) hashTxtLinkDraw.innerHTML = hashTxtMainLinkHtml;
            const hashTxtCommitLinkDraw = document.getElementById('hashTxtCommitLink_drawTab');
            if (hashTxtCommitLinkDraw) hashTxtCommitLinkDraw.innerHTML = hashTxtCommitLinkHtml;

            // 이메일 확인 탭의 hash.txt 링크 (메인 설명)
            const hashTxtLinkCheck = document.getElementById('hashTxtLink_checkTab');
            if (hashTxtLinkCheck) hashTxtLinkCheck.innerHTML = hashTxtMainLinkHtmlBold;
            const hashTxtCommitLinkCheck = document.getElementById('hashTxtCommitLink_checkTab');
            if (hashTxtCommitLinkCheck) hashTxtCommitLinkCheck.innerHTML = hashTxtCommitLinkHtml;

            // 이메일 확인 결과 내 중첩된 hash.txt 링크 (없을 경우)
            const hashTxtLinkCheckNested = document.getElementById('hashTxtLink_checkTab_nested');
            if (hashTxtLinkCheckNested) hashTxtLinkCheckNested.innerHTML = hashTxtMainLinkHtmlBold;
            const hashTxtCommitLinkCheckNested = document.getElementById('hashTxtCommitLink_checkTab_nested');
            if (hashTxtCommitLinkCheckNested) hashTxtCommitLinkCheckNested.innerHTML = hashTxtCommitLinkHtml;

            // 이메일 확인 결과 내 중첩된 hash.txt 링크 (있을 경우)
            const hashTxtLinkCheckNestedFound = document.getElementById('hashTxtLink_checkTab_nested_found');
            if (hashTxtLinkCheckNestedFound) hashTxtLinkCheckNestedFound.innerHTML = hashTxtMainLinkHtml; // 볼드 스타일 제외
            const hashTxtCommitLinkCheckNestedFound = document.getElementById('hashTxtCommitLink_checkTab_nested_found');
            if (hashTxtCommitLinkCheckNestedFound) hashTxtCommitLinkCheckNestedFound.innerHTML = hashTxtCommitLinkHtml;

            // hash.txt를 Fetch할 때도 Raw URL을 사용하도록 수정
            // generateAndCheckHash와 drawWinner 함수 내에서 사용되는 fetch URL을 동적으로 가져오도록 함
        }


        // 페이지 로드 시 첫 번째 탭 열기 및 GitHub 링크 생성
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.tablinks.active').click();
            generateGitHubLinks(); // GitHub 소스코드 및 파일 이력 링크 생성 함수 호출
        });
    </script>
</body>
</html>
